---
import Layout from "@/layout/Layout.astro";
import { calculateAllCharacterStats } from "@/utils/characterStats";
import { getCollection } from "astro:content";

const allStats = await calculateAllCharacterStats();
const characters = await getCollection("characters");

const characterStatsArray = Object.values(allStats)
  .filter((stat: any) => stat.totalScenes > 0)
  .map((stat: any) => {
    const character = characters.find(c => c.slug === stat.characterSlug);
    return {
      characterSlug: stat.characterSlug,
      characterName: stat.characterName,
      totalLines: stat.totalLines,
      totalScenes: stat.totalScenes,
      linesByAct: Array.from(stat.linesByAct.entries()),
      scenesByAct: Array.from(stat.scenesByAct.entries()),
      sceneAppearances: stat.sceneAppearances,
      firstAppearance: stat.firstAppearance,
      lastAppearance: stat.lastAppearance,
      role: character?.data.role || 'unknown',
      characterType: character?.data.character_type || 'unknown',
    };
  })
  .sort((a, b) => b.totalScenes - a.totalScenes);

---

<Layout title="Character Statistics">
  <div class="stats-page">
    <div class="page-header">
      <h1>Character Statistics</h1>
      <p class="subtitle">Performance analytics for all characters in the screenplay</p>
    </div>

    <div class="stats-container" x-data={`{
      characters: ${JSON.stringify(characterStatsArray)},
      sortBy: 'totalLines',
      sortDirection: 'desc',
      filterRole: 'all',
      filterAct: 'all',
      get filteredAndSortedCharacters() {
        let filtered = this.characters;
        
        if (this.filterRole !== 'all') {
          filtered = filtered.filter(c => c.role === this.filterRole);
        }
        
        if (this.filterAct !== 'all') {
          const act = parseInt(this.filterAct);
          filtered = filtered.filter(c => c.scenesByAct.some(([a]) => a === act));
        }
        
        filtered.sort((a, b) => {
          let aVal = a[this.sortBy];
          let bVal = b[this.sortBy];
          
          if (this.sortBy === 'characterName') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
          }
          
          if (this.sortDirection === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
          } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
          }
        });
        
        return filtered;
      }
    }`}>
      
      <div class="controls">
        <div class="control-group">
          <label for="sort-by">Sort by:</label>
          <select id="sort-by" x-model="sortBy">
            <option value="totalLines">Total Lines</option>
            <option value="totalScenes">Scene Appearances</option>
            <option value="characterName">Character Name</option>
          </select>
        </div>

        <div class="control-group">
          <label for="sort-direction">Direction:</label>
          <select id="sort-direction" x-model="sortDirection">
            <option value="desc">Descending</option>
            <option value="asc">Ascending</option>
          </select>
        </div>

        <div class="control-group">
          <label for="filter-role">Role:</label>
          <select id="filter-role" x-model="filterRole">
            <option value="all">All Roles</option>
            <option value="protagonist">Protagonist</option>
            <option value="antagonist">Antagonist</option>
            <option value="supporting">Supporting</option>
            <option value="minor">Minor</option>
          </select>
        </div>

        <div class="control-group">
          <label for="filter-act">Act:</label>
          <select id="filter-act" x-model="filterAct">
            <option value="all">All Acts</option>
            <option value="1">Act 1</option>
            <option value="2">Act 2</option>
            <option value="3">Act 3</option>
          </select>
        </div>
      </div>

      <div class="stats-summary">
        <div class="summary-card">
          <div class="summary-label">Total Characters</div>
          <div class="summary-value" x-text="filteredAndSortedCharacters.length"></div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total Lines</div>
          <div class="summary-value" x-text="filteredAndSortedCharacters.reduce((sum, c) => sum + c.totalLines, 0)"></div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Avg Lines/Character</div>
          <div class="summary-value" x-text="Math.round(filteredAndSortedCharacters.reduce((sum, c) => sum + c.totalLines, 0) / filteredAndSortedCharacters.length || 0)"></div>
        </div>
      </div>

      <div class="character-table">
        <table>
          <thead>
            <tr>
              <th @click="sortBy = 'characterName'; sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'" class="sortable">
                Character
                <span class="sort-indicator" x-show="sortBy === 'characterName'" x-text="sortDirection === 'asc' ? '▲' : '▼'"></span>
              </th>
              <th>Role</th>
              <th @click="sortBy = 'totalLines'; sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'" class="sortable">
                Total Lines
                <span class="sort-indicator" x-show="sortBy === 'totalLines'" x-text="sortDirection === 'asc' ? '▲' : '▼'"></span>
              </th>
              <th @click="sortBy = 'totalScenes'; sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'" class="sortable">
                Scenes
                <span class="sort-indicator" x-show="sortBy === 'totalScenes'" x-text="sortDirection === 'asc' ? '▲' : '▼'"></span>
              </th>
              <th>Act 1</th>
              <th>Act 2</th>
              <th>Act 3</th>
              <th>First/Last</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="char in filteredAndSortedCharacters" :key="char.characterSlug">
              <tr>
                <td>
                  <a :href="`/characters/${char.characterSlug}`" class="character-link" x-text="char.characterName"></a>
                </td>
                <td>
                  <span class="role-badge" :class="`role-${char.role}`" x-text="char.role"></span>
                </td>
                <td class="numeric-cell">
                  <span class="highlight-value" x-text="char.totalLines"></span>
                </td>
                <td class="numeric-cell" x-text="char.totalScenes"></td>
                <td class="numeric-cell">
                  <span x-text="char.linesByAct.find(([act]) => act === 1)?.[1] || 0"></span>
                  <span class="scene-count" x-text="`(${char.scenesByAct.find(([act]) => act === 1)?.[1] || 0})`"></span>
                </td>
                <td class="numeric-cell">
                  <span x-text="char.linesByAct.find(([act]) => act === 2)?.[1] || 0"></span>
                  <span class="scene-count" x-text="`(${char.scenesByAct.find(([act]) => act === 2)?.[1] || 0})`"></span>
                </td>
                <td class="numeric-cell">
                  <span x-text="char.linesByAct.find(([act]) => act === 3)?.[1] || 0"></span>
                  <span class="scene-count" x-text="`(${char.scenesByAct.find(([act]) => act === 3)?.[1] || 0})`"></span>
                </td>
                <td class="appearance-cell">
                  <template x-if="char.firstAppearance">
                    <div>
                      <div class="appearance-info">
                        <span class="appearance-label">First:</span>
                        <a :href="`/scenes/${char.firstAppearance.slug}`" x-text="`${char.firstAppearance.act}.${char.firstAppearance.sceneNumber}`"></a>
                      </div>
                      <div class="appearance-info" x-show="char.lastAppearance && char.firstAppearance.slug !== char.lastAppearance.slug">
                        <span class="appearance-label">Last:</span>
                        <a :href="`/scenes/${char.lastAppearance.slug}`" x-text="`${char.lastAppearance.act}.${char.lastAppearance.sceneNumber}`"></a>
                      </div>
                    </div>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</Layout>

<style>
  .stats-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .page-header {
    margin-bottom: 2rem;
    text-align: center;
  }

  .page-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2.5rem;
    color: var(--color-text-primary, #1a1a1a);
  }

  .subtitle {
    color: var(--color-text-secondary, #666666);
    font-size: 1.1rem;
    margin: 0;
  }

  .stats-container {
    background: var(--color-surface, #ffffff);
    border: 1px solid var(--color-border, #e0e0e0);
    border-radius: 8px;
    padding: 2rem;
  }

  .controls {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--color-border, #e0e0e0);
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .control-group label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-secondary, #666666);
  }

  .control-group select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--color-border, #e0e0e0);
    border-radius: 6px;
    background: var(--color-background, #f9f9f9);
    color: var(--color-text-primary, #1a1a1a);
    font-size: 0.9rem;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .control-group select:hover {
    border-color: var(--color-primary, #0066cc);
  }

  .control-group select:focus {
    outline: none;
    border-color: var(--color-primary, #0066cc);
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  .stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
  }

  .summary-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
  }

  .summary-value {
    font-size: 2.5rem;
    font-weight: 700;
  }

  .character-table {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  thead {
    background: var(--color-background, #f9f9f9);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--color-text-primary, #1a1a1a);
    border-bottom: 2px solid var(--color-border, #e0e0e0);
  }

  th.sortable {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }

  th.sortable:hover {
    background: var(--color-border-light, #f0f0f0);
  }

  .sort-indicator {
    margin-left: 0.5rem;
    font-size: 0.75rem;
    color: var(--color-primary, #0066cc);
  }

  tbody tr {
    border-bottom: 1px solid var(--color-border-light, #f0f0f0);
    transition: background-color 0.2s ease;
  }

  tbody tr:hover {
    background: var(--color-background, #f9f9f9);
  }

  td {
    padding: 1rem;
  }

  .character-link {
    color: var(--color-primary, #0066cc);
    text-decoration: none;
    font-weight: 500;
  }

  .character-link:hover {
    text-decoration: underline;
  }

  .role-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .role-protagonist {
    background: #e3f2fd;
    color: #1976d2;
  }

  .role-antagonist {
    background: #ffebee;
    color: #c62828;
  }

  .role-supporting {
    background: #f3e5f5;
    color: #7b1fa2;
  }

  .role-minor {
    background: #f5f5f5;
    color: #616161;
  }

  .numeric-cell {
    text-align: center;
    font-family: "JetBrains Mono", monospace;
  }

  .highlight-value {
    font-weight: 700;
    color: var(--color-accent, #764ba2);
    background: var(--color-accent-bg, #f3e5f5);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .scene-count {
    font-size: 0.75rem;
    color: var(--color-text-muted, #999999);
    margin-left: 0.25rem;
  }

  .appearance-cell {
    font-size: 0.85rem;
  }

  .appearance-info {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .appearance-label {
    color: var(--color-text-muted, #999999);
    font-weight: 600;
  }

  .appearance-info a {
    color: var(--color-primary, #0066cc);
    text-decoration: none;
  }

  .appearance-info a:hover {
    text-decoration: underline;
  }

  @media (max-width: 1200px) {
    .stats-page {
      padding: 1rem;
    }

    .stats-container {
      padding: 1rem;
    }

    .character-table {
      font-size: 0.8rem;
    }

    th, td {
      padding: 0.75rem 0.5rem;
    }
  }

  @media (max-width: 768px) {
    .page-header h1 {
      font-size: 1.75rem;
    }

    .controls {
      flex-direction: column;
    }

    .control-group {
      width: 100%;
    }

    .stats-summary {
      grid-template-columns: 1fr;
    }

    .summary-value {
      font-size: 2rem;
    }

    table {
      font-size: 0.75rem;
    }

    .character-table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }
</style>

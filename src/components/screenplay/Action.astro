---
/**
 * Action
 *
 * - Renders scene action
 * - Uses narrator voice for playback
 */

import { voiceMap } from "../../utils/voices/voiceMap.ts";

const voice = voiceMap.narrator;
---

<div class="action" data-voice={voice?.id}>
  {voice && <button class="speak" aria-label="Play action">▶</button>}
  <slot />
</div>

{voice && (
<script is:inline>
(() => {
  // Apply voice configuration to utterance
  function applyVoiceConfig(utterance, voiceType) {
    // Get saved configuration
    const savedConfig = localStorage.getItem('voiceConfig');
    if (!savedConfig) {
      console.log("No saved voice configuration found");
      return;
    }
    
    try {
      const config = JSON.parse(savedConfig);
      console.log("Using voice config:", config);
      
      let voiceConfig = null;
      let voiceSource = '';
      
      if (voiceType === 'narrator') {
        voiceConfig = config.narrator;
        voiceSource = 'narrator';
        console.log("Using narrator config for action");
      }
      
      console.log(`Voice config for ${voiceSource}:`, voiceConfig);
      
      if (voiceConfig) {
        // Apply voice selection
        if (voiceConfig.voice && voiceConfig.voice !== '') {
          const voices = window.speechSynthesis.getVoices();
          console.log("Available voices for selection:", voices.map(v => v.name));
          
          const selectedVoice = voices.find(v => v.name === voiceConfig.voice);
          if (selectedVoice) {
            utterance.voice = selectedVoice;
            console.log(`✅ Applied voice: ${selectedVoice.name} for ${voiceSource}`);
          } else {
            console.warn(`❌ Voice not found: ${voiceConfig.voice} for ${voiceSource}`);
            console.log("Available voices:", voices.map(v => v.name));
          }
        } else {
          console.log(`No voice configured for ${voiceSource}, using default`);
        }
        
        // Apply speed
        if (voiceConfig.speed && voiceConfig.speed !== 1) {
          const speed = parseFloat(voiceConfig.speed);
          utterance.rate = speed;
          console.log(`✅ Applied speed: ${speed} for ${voiceSource}`);
        } else {
          console.log(`Using default speed (1.0) for ${voiceSource}`);
        }
        
        // Apply pitch
        if (voiceConfig.pitch && voiceConfig.pitch !== 1) {
          const pitch = parseFloat(voiceConfig.pitch);
          utterance.pitch = pitch;
          console.log(`✅ Applied pitch: ${pitch} for ${voiceSource}`);
        } else {
          console.log(`Using default pitch (1.0) for ${voiceSource}`);
        }
      } else {
        console.log(`No voice configuration found for ${voiceSource}`);
      }
    } catch (error) {
      console.error("Error applying voice configuration:", error);
    }
  }

  // Check if we're on an episode page - if so, let global handler manage it
  if (window.location.pathname.includes('/episodes/')) {
    console.log("Episode page detected - skipping individual script");
    return;
  }
  
  console.log("Action script executing...");
  
  // Wait for DOM to be ready
  const initHandler = () => {
    // Find all unhandled action elements and take the last one
    const actions = document.querySelectorAll('.action[data-voice]:not([data-handled])');
    const thisAction = actions[actions.length - 1]; // Take last instead of first
    
    console.log("Found action elements:", actions.length, "Taking element at index:", actions.length - 1);
    
    if (thisAction) {
      // Mark as handled to avoid duplicate processing
      thisAction.setAttribute('data-handled', 'true');
      
      const btn = thisAction.querySelector(".speak");
      const voiceId = thisAction.dataset.voice;
      
      console.log("Action script loaded", { btn: !!btn, voiceId });
      
      if (btn && voiceId) {
        let isPlaying = false;
        let currentUtterance = null;
        
        const updateButton = () => {
          btn.textContent = isPlaying ? '■' : '▶';
          btn.setAttribute('aria-label', isPlaying ? 'Stop action' : 'Play action');
        };
        
        const extractText = () => {
          // Clone the element and remove the button, then get text
          const clone = thisAction.cloneNode(true);
          const button = clone.querySelector('.speak');
          if (button) button.remove();
          return clone.textContent?.replace(/\s+/g, " ").trim() ?? "";
        };
        
        btn.addEventListener("click", (e) => {
          console.log("Action button clicked!", { isPlaying, voiceId });
          e.preventDefault();
          e.stopPropagation();
          
          if (isPlaying) {
            // Stop speaking
            window.speechSynthesis.cancel();
            isPlaying = false;
            updateButton();
            console.log("Stopped speaking action");
          } else {
            // Start speaking
            const text = extractText();
            console.log("Speaking action:", { text, voiceId });
            
            if ('speechSynthesis' in window && text) {
              currentUtterance = new SpeechSynthesisUtterance(text);
              
              // Apply voice configuration
              console.log("About to apply voice configuration for action...");
              applyVoiceConfig(currentUtterance, 'narrator');
              console.log("Voice configuration applied for action");
              
              currentUtterance.onstart = () => {
                isPlaying = true;
                updateButton();
                console.log("Action started speaking");
              };
              
              currentUtterance.onend = () => {
                isPlaying = false;
                updateButton();
                console.log("Action finished speaking");
              };
              
              currentUtterance.onerror = (e) => {
                console.error("Speech error:", e);
                isPlaying = false;
                updateButton();
              };
              
              window.speechSynthesis.speak(currentUtterance);
            } else {
              console.error("Speech synthesis not supported or no text");
            }
          }
        });
        
        // Add debug functionality
        btn.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          console.log("Available voices:", window.speechSynthesis?.getVoices()?.map(v => v.name));
          console.log("Current voiceId:", voiceId);
        });
        
        // Initialize button
        updateButton();
      }
    } else {
      console.log("No unhandled action found");
    }
  };
  
  // Check if DOM is already ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHandler);
  } else {
    initHandler();
  }
})();
</script>

)}
